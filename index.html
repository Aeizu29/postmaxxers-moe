<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSTMAXXERS.MOE - Live Tracking</title>
    <style>
        /* Vos styles restent identiques */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #1a2332; color: #e4e6eb; padding: 20px; }
        .header { text-align: center; font-size: 48px; font-weight: bold; margin-bottom: 30px; letter-spacing: 2px; color: #ffffff; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1800px; margin: 0 auto; }
        .section { background: #23304a; border: 2px solid #2d3e5f; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section-title { font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #ffffff; padding-bottom: 15px; border-bottom: 2px solid #2d3e5f; }
        .leaderboard-item { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 2px; background: #2d3e5f; transition: background 0.2s; position: relative; }
        .avatar { width: 48px; height: 48px; border-radius: 4px; margin-right: 12px; object-fit: cover; background: #1a2332; }
        .user-info { flex: 1; display: flex; flex-direction: column; }
        .username { font-weight: 600; font-size: 16px; color: #e4e6eb; }
        .username.special { color: #ff4757; }
        .post-info { text-align: right; min-width: 120px; }
        .post-count { font-weight: bold; font-size: 18px; color: #ffffff; }
        .status { text-align: center; margin-bottom: 20px; padding: 12px; background: #2d3e5f; border-radius: 8px; font-weight: bold; max-width: 1800px; margin: 0 auto 20px auto; }
        .live-indicator { display: inline-block; width: 8px; height: 8px; background-color: #00ff00; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .error { background: #4a2329; color: #ff6b6b; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #6b2c35; }
    </style>
</head>
<body>
    <div class="header">POSTMAXXERS.MOE</div>
    
    <div class="status">
        <span class="live-indicator"></span>
        <span id="statusText">Initialisation...</span>
    </div>

    <div class="container">
        <div class="section">
            <div class="section-title">GLOBAL LEADERBOARD</div>
            <div id="leaderboard">Chargement des données...</div>
        </div>

        <div class="section">
            <div class="section-title">TOP DAILY INCREASES</div>
            <div id="topPostmaxxer">Calcul en cours...</div>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        // REMPLACEZ CETTE URL PAR VOTRE URL RENDER (ex: https://mon-proxy.onrender.com)
        const RENDER_URL = "https://VOTRE-URL-ICI.onrender.com"; 
        
        // Vos cookies (ceux-ci sont envoyés au proxy)
        const COOKIES = "xf_user=59719%2CYWotAo_Jm0vhz0Bdf22JVEiazdTkHIKlasC-ZEmv; xf_session=tBqpefecYhvBemOvJnxB8rzr4cctE7lT; xf_csrf=T8JwXdIYK-0X3tlQ";
        const FORUM_URL = "https://incels.is/members/?key=most_posts";
        // =====================

        let dailyStartCounts = JSON.parse(localStorage.getItem('daily_start_counts') || '{}');
        let lastDate = localStorage.getItem('tracking_date');

        async function fetchLeaderboard() {
            try {
                updateStatus('Mise à jour en cours...');
                
                // On appelle le proxy sur Render
                const target = `${RENDER_URL}/proxy?url=${encodeURIComponent(FORUM_URL)}&cookies=${encodeURIComponent(COOKIES)}`;
                const response = await fetch(target);
                
                if (!response.ok) throw new Error('Le serveur proxy ne répond pas');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Parsing des données (Simplifié pour l'exemple, à adapter selon la structure du forum)
                const users = [];
                const rows = doc.querySelectorAll('.memberListItem, .contentRow'); // Sélecteurs à vérifier sur incels.is
                
                rows.forEach((row, i) => {
                    const username = row.querySelector('.username')?.textContent.trim();
                    const postsStr = row.textContent.match(/Posts:?\s*([\d,]+)/i);
                    const avatar = row.querySelector('img.avatar')?.src;

                    if (username && postsStr) {
                        const posts = parseInt(postsStr[1].replace(/,/g, ''));
                        users.push({
                            rank: i + 1,
                            username,
                            postCount: posts,
                            avatarUrl: avatar
                        });
                    }
                });

                processUsers(users);

            } catch (error) {
                console.error(error);
                document.getElementById('leaderboard').innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
                updateStatus('❌ Erreur de connexion');
            }
        }

        function processUsers(users) {
            const today = new Date().toDateString();
            
            // Reset journalier
            if (lastDate !== today) {
                dailyStartCounts = {};
                users.forEach(u => dailyStartCounts[u.username] = u.postCount);
                localStorage.setItem('daily_start_counts', JSON.stringify(dailyStartCounts));
                localStorage.setItem('tracking_date', today);
                lastDate = today;
            }

            // Calcul du gain
            users.forEach(u => {
                const start = dailyStartCounts[u.username] || u.postCount;
                u.dailyIncrease = u.postCount - start;
            });

            renderUI(users);
        }

        function renderUI(users) {
            // Leaderboard Global
            const lbHtml = users.slice(0, 20).map(u => `
                <div class="leaderboard-item">
                    <img src="${u.avatarUrl || ''}" class="avatar" onerror="this.src='https://placehold.co/48x48?text=?'">
                    <div class="user-info">
                        <div class="username ${u.rank <= 3 ? 'special' : ''}">${u.username}</div>
                        <div style="font-size: 12px; color: #8b9cb6">Rang #${u.rank}</div>
                    </div>
                    <div class="post-info">
                        <div class="post-count">${u.postCount.toLocaleString()}</div>
                        <div style="color: #4CAF50; font-size: 12px">+${u.dailyIncrease} today</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('leaderboard').innerHTML = lbHtml;

            // Top Daily
            const daily = [...users].sort((a,b) => b.dailyIncrease - a.dailyIncrease).slice(0, 10);
            const dailyHtml = daily.map(u => `
                <div class="leaderboard-item">
                    <div class="user-info">
                        <div class="username">${u.username}</div>
                    </div>
                    <div class="post-info">
                        <div class="post-count" style="color: #4CAF50">+${u.dailyIncrease}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('topPostmaxxer').innerHTML = dailyHtml;
            
            updateStatus('✅ Connecté - Mise à jour auto (5 min)');
        }

        function updateStatus(msg) {
            document.getElementById('statusText').textContent = msg;
        }

        // Lancement
        fetchLeaderboard();
        setInterval(fetchLeaderboard, 300000); // 5 minutes
    </script>
</body>
</html>
